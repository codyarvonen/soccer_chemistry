import time
import sqlite3
from concurrent.futures import ThreadPoolExecutor
from concurrent.futures import as_completed
from threading import Thread, local
from tqdm import tqdm

from create_team_graph import get_match_stats

thread_local = local()

dir_name = 'WC_2006'
db_file_name = 'lineups.db'

# matches_2018 = [498202, 498201, 498200, 498199, 498198, 498197, 498196, 498195, 498194, 498193, 498192, 498191, 498190, 498189, 498188, 498187, 498186, 498185, 498184, 498183, 498182, 498181, 498180, 498179, 498178, 498177, 498176, 498175, 498174, 498173, 498172, 498171, 498170, 498169, 498168, 498167, 498166, 498165, 498164, 498163, 498162, 498161, 498160, 498159, 498158, 498157, 498156, 498155, 498154, 498153, 498152, 498151, 498150, 498149, 498148, 498147, 498146, 498145, 498144, 498143, 498142, 498141, 498140, 498139]
# matches_2014 = [383300, 383301, 383302, 383303, 383296, 383297, 383298, 383299, 383293, 383294, 383295, 383292, 383291, 383290,383289, 383288, 383287, 383286, 383285, 383284, 383283, 383282, 383281, 383280, 383279, 383278, 383277, 383276, 383275, 383274, 383273, 383272, 383271, 383270, 383269, 383268, 383267, 383266, 383265, 383264, 383263, 383262, 383261, 383260, 383259, 383258, 383257, 383256, 383254, 383253, 383252, 383251, 383250, 383249, 383248, 383247, 383246, 383245, 383244, 383243, 383242, 383241, 383240, 383239]
# matches_2010 = [264031, 264032, 264037, 264038, 264043, 264044, 264049, 264050, 264055, 264056, 264061, 264062, 264067, 264068, 264033, 264073, 264074, 264034,  264039, 264040, 264045, 264046, 264051, 264052, 264057, 264058, 264063, 264064, 264069, 264070, 264075, 264076, 264035, 264036, 264041, 264042, 264047, 264048, 264053, 264054, 264059, 264060, 264065, 264066, 264071, 264072, 264077, 264078, 264108, 264109, 264110, 264111, 264112, 264113, 264114, 264115, 264116, 264117, 264118, 264119, 264120, 264121, 264122, 264123]
# matches = [264040]
# 264031
# 383241
# matches = [383241]
matches = [191918, 191919, 191920, 191921, 191922, 191923, 191924, 191925, 191926, 191927, 191929, 191928, 191930, 191931, 191922, 191923, 191924, 191935, 191936, 191937, 191938, 191939, 191940,191941, 191942, 191943, 191944, 191945, 191946, 191947, 191948, 191949, 191950, 191951, 191952, 191953, 191954, 191955, 191956, 191957, 191958, 191959, 191960, 191961, 191962, 191963, 191964, 191965, 191966, 191967, 191968, 191969, 191970, 191971, 191972, 191973, 191974, 191975, 191976, 191977, 191978, 191979, 191980, 191983]

def get_connection() -> sqlite3.Connection:
    return sqlite3.connect(db_file_name)

def save_match(id):
    get_match_stats(get_connection(), id, dir_name)

def save_all(match_ids:list) -> None:
    l = len(match_ids)
    with tqdm(total=l) as pbar:
        with ThreadPoolExecutor(max_workers=12) as executor:
            futures = {executor.submit(save_match, arg): arg for arg in match_ids}
            results = {}
            for future in as_completed(futures):
                arg = futures[future]
                results[arg] = future.result()
                pbar.update(1)

print("Begining all threads")
start = time.time()
save_all(matches)
end = time.time()

print(f'Saved {len(matches)} matches in {end - start} seconds')

